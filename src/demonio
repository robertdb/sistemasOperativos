#! /usr/bin/env bash

LOGFILE=demonio
source log.sh

if [ ! -v DIRABUS ]; then DIRABUS=dirabus; fi
if [ ! -d $DIRABUS ]; then mkdir --parents $DIRABUS; fi

if [ ! -v ACEPTADOS ]; then ACEPTADOS=aceptados; fi
if [ ! -d $ACEPTADOS ]; then mkdir --parents $ACEPTADOS; fi

if [ ! -v RECHAZADOS ]; then RECHAZADOS=rechazados; fi
if [ ! -d $RECHAZADOS ]; then mkdir --parents $RECHAZADOS; fi

# Rechaza un archivo y registra el evento en el log.
#
# El segundo argumento es un mensaje opcional que se agrega al log.
function rechazar() {
    mv ${1:?"rechazar llamado sin argumentos"} $RECHAZADOS
    log archivo rechazado: $1${2:+, $2}
}

function aceptar() {
    mv ${1?"aceptar llamado sin argumentos"} $ACEPTADOS
    log archivo aceptado: $1
}

for (( i = 1; ; i++ )); do
    sleep 1

    log $i
    if [ $(($i%100)) -eq 0 ]; then truncate; fi

    if [ -z $(ls -A $DIRABUS) ]; then continue; fi


    for file in $DIRABUS/*; do
        if ! [[ $file =~ [^_]+_[^_]+\.txt ]]; then
            rechazar $file "nombre mal formado"
            continue
        fi
        if ! [ -s $file ]; then
            rechazar $file "vacio"
            continue
        fi
        if ! [ file $file ~= ASCII ]; then
            rechazar $file "no es ASCII"
            continue
        fi

        aceptar $file
    done
done
